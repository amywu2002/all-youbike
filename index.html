<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>桃園 YouBike 站點地圖</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

#map {
  height: 100vh;
  width: 100%;
}

/* ===== UI ===== */
#count {
  position: absolute;
  top: 12px;
  left: 12px;
  z-index: 1000;
  background: #fff;
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 14px;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
}

#controls {
  position: absolute;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  display: flex;
  gap: 8px;
}

#search,
#statusFilter {
  padding: 8px 12px;
  font-size: 15px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,.15);
}

/* ===== 官方色 ===== */
.marker.green  { --c:#7AC943; }
.marker.yellow { --c:#F5A623; }
.marker.red    { --c:#A80000; }

/* 移除 Leaflet 預設底 */
.leaflet-div-icon {
  background: transparent !important;
  border: none !important;
}

/* Marker 尺寸（手機放大） */
.marker svg {
  width: 60px;
  height: 68px;
}

/* +- 移到右上 */
.leaflet-top.leaflet-left {
  right: 12px;
  left: auto;
}

/* ===== 使用者定位（最上層） ===== */
.leaflet-pane.userLocation {
  z-index: 2000 !important;
  pointer-events: none;
}

.user-dot {
  width: 18px;
  height: 18px;
  background: #007AFF;
  border-radius: 50%;
  border: 3px solid #fff;
  box-shadow:
    0 2px 6px rgba(0,0,0,.35),
    0 0 0 2px rgba(0,122,255,.25);
}
</style>
</head>

<body>

<div id="count">站點：--</div>

<div id="controls">
  <input id="search" placeholder="搜尋站點名稱…" />
  <select id="statusFilter">
    <option value="all">全部</option>
    <option value="green">正常</option>
    <option value="yellow">無車</option>
    <option value="red">無位</option>
  </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ===== 地圖 ===== */
const map = L.map("map").setView([24.9936, 121.3010], 12);
map.zoomControl.setPosition("topright");

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

/* ===== Pane（定位一定在最上） ===== */
map.createPane("userLocation");
map.getPane("userLocation").classList.add("userLocation");

const DATA_URL = "stations.json";
let rawData = [];
let markers = [];
let userMarker = null;

/* ===== 工具 ===== */
function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}

function getStatus(borrow, ret) {
  if (ret === 0) return "red";
  if (borrow === 0) return "yellow";
  return "green";
}

/* ===== 官方水滴 ===== */
function makeMarkerHTML(borrow, ret, status) {
  return `
  <div class="marker ${status}">
    <svg viewBox="0 0 64 72">
      <path
        d="M32 2
           C20 2 10 12 10 26
           C10 44 32 68 32 68
           C32 68 54 44 54 26
           C54 12 44 2 32 2Z"
        fill="var(--c)"
        stroke="#fff"
        stroke-width="3"
      />
      <line x1="20" y1="34" x2="44" y2="34"
        stroke="#fff" stroke-width="2" opacity="0.85"/>
      <text x="32" y="26" text-anchor="middle"
        font-size="16" font-weight="700" fill="#fff">${borrow}</text>
      <text x="32" y="48" text-anchor="middle"
        font-size="14" font-weight="600" fill="#fff">${ret}</text>
    </svg>
  </div>`;
}

/* ===== 渲染站點 ===== */
function render() {
  clearMarkers();

  const keyword = search.value.trim();
  const filter = statusFilter.value;

  const list = rawData.filter(s => {
    const b = Number(s.sbi);
    const r = Number(s.bemp);
    const st = getStatus(b, r);

    if (filter !== "all" && st !== filter) return false;
    if (keyword && !s.sna.includes(keyword)) return false;
    return true;
  });

  list.forEach(s => {
    const lat = Number(s.lat);
    const lng = Number(s.lng);
    if (isNaN(lat) || isNaN(lng)) return;

    const borrow = Number(s.sbi);
    const ret = Number(s.bemp);
    const status = getStatus(borrow, ret);

    const icon = L.divIcon({
      iconSize: [60, 68],
      iconAnchor: [30, 68],
      html: makeMarkerHTML(borrow, ret, status)
    });

    const marker = L.marker([lat, lng], { icon }).addTo(map);
    markers.push(marker);
  });

  count.textContent = `站點：${markers.length} 筆`;
}

/* ===== 自動定位（最上層藍點） ===== */
function locateUser() {
  if (!navigator.geolocation) return;

  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;

    if (userMarker) map.removeLayer(userMarker);

    userMarker = L.marker([latitude, longitude], {
      pane: "userLocation",
      zIndexOffset: 10000,
      icon: L.divIcon({
        className: "",
        iconSize: [24, 24],
        html: `<div class="user-dot"></div>`
      })
    }).addTo(map);

    map.setView([latitude, longitude], 14);
  });
}

/* ===== 載入資料 ===== */
fetch(DATA_URL)
  .then(res => res.json())
  .then(json => {
    rawData = json.retVal;
    render();
    locateUser();
  });

search.addEventListener("input", render);
statusFilter.addEventListener("change", render);
</script>

</body>
</html>
